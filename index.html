<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>‚ùå‚≠ï Morpion 1v1</title>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  min-height:100vh;
  background:radial-gradient(circle at top,#0f172a,#020617);
  font-family:system-ui,Arial;
  color:#f0f9ff;
  display:flex;
  justify-content:center;
  padding:20px;
}
.container{
  width:100%;
  max-width:420px;
  background:#0b1120;
  border-radius:16px;
  padding:20px;
  border:1px solid #1e3a8a;
}
h1{text-align:center;color:#60a5fa}
.credits{
  text-align:center;
  font-size:22px;
  font-weight:bold;
  margin-bottom:10px;
  color:#3b82f6;
}
button,input{
  width:100%;
  padding:12px;
  margin:6px 0;
  border-radius:10px;
  border:none;
  font-size:16px;
}
button{
  background:linear-gradient(135deg,#3b82f6,#1d4ed8);
  color:#fff;
  font-weight:700;
}
.board{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:8px;
  margin-top:10px;
}
.cell{
  height:90px;
  font-size:40px;
  font-weight:bold;
  background:#020617;
  border-radius:10px;
  display:flex;
  justify-content:center;
  align-items:center;
}
.list{margin-top:10px}
.challenge{
  background:#020617;
  padding:10px;
  border-radius:10px;
  margin-bottom:6px;
}
.msg{text-align:center;margin:10px 0;color:#7dd3fc}

/* MODAL */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.75);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:999;
}
.modal-content{
  background:#0b1120;
  padding:20px;
  border-radius:16px;
  width:90%;
  max-width:300px;
  text-align:center;
}
</style>
</head>

<body>
<div class="container">
<h1>‚ùå‚≠ï Morpion 1v1</h1>

<div class="credits">üí∞ <span id="credits">0</span> cr√©dits</div>

<input id="bet" type="number" placeholder="Mise">
<button id="createBtn">Cr√©er un d√©fi</button>

<div class="list" id="challenges"></div>
<div class="board" id="board"></div>
<div class="msg" id="msg"></div>

<button onclick="location.href='https://kikoco16.github.io/Casino-Endiorite/'">‚¨Ö Retour</button>
</div>

<!-- MODAL -->
<div class="modal" id="waitingModal">
  <div class="modal-content">
    <p>‚è≥ En attente d‚Äôun adversaire‚Ä¶</p>
    <button id="cancelBtn">‚ùå Annuler le d√©fi</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getDatabase, ref, get, set, update, onValue, remove } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDAQALLN99kqiYY4UZz9wl2stedP5KQ5mA",
  databaseURL: "https://casino-b23c9-default-rtdb.europe-west1.firebasedatabase.app",
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// üîê Connexion obligatoire
const user = localStorage.getItem("casinoUser");
if(!user){
  alert("Vous devez √™tre connect√©");
  location.href="https://kikoco16.github.io/Casino-Endiorite/";
}

// UI
const creditsEl = document.getElementById("credits");
const modal = document.getElementById("waitingModal");
const cancelBtn = document.getElementById("cancelBtn");
const boardEl = document.getElementById("board");
const msg = document.getElementById("msg");
const challengesEl = document.getElementById("challenges");

let currentChallenge = null;

// ü™ô Cr√©dits live
onValue(ref(db,"users/"+user+"/credits"), s=>{
  creditsEl.textContent = s.exists()?s.val():0;
});

// ‚ûï Cr√©er d√©fi
document.getElementById("createBtn").onclick = async ()=>{
  const bet = parseInt(document.getElementById("bet").value);
  if(!bet || bet<=0) return;

  const userRef = ref(db,"users/"+user);
  const snap = await get(userRef);
  if(bet > snap.val().credits) return alert("Cr√©dits insuffisants");

  await update(userRef,{ credits: snap.val().credits - bet });

  const id = Date.now();
  await set(ref(db,"d√©fis1v1/"+id),{
    status:"waiting",
    bet,
    board:["","","","","","","","",""],
    currentTurn:"player1",
    players:{ player1:{ uid:user, symbol:"X" } }
  });
};

// üìã Observer d√©fis
onValue(ref(db,"d√©fis1v1"), snap=>{
  challengesEl.innerHTML="";
  modal.style.display="none";

  snap.forEach(ch=>{
    const c = ch.val();
    const id = ch.key;

    const players = Object.values(c.players||{});
    const isMe = players.some(p=>p.uid===user);

    // MODAL ATTENTE
    if(isMe && c.status==="waiting"){
      currentChallenge=id;
      modal.style.display="flex";

      cancelBtn.onclick = async ()=>{
        const bet = c.bet;
        const userRef = ref(db,"users/"+user);
        const us = await get(userRef);
        await update(userRef,{ credits: us.val().credits + bet });
        await remove(ref(db,"d√©fis1v1/"+id));
      };
      return;
    }

    // LISTE ACCEPTABLES
    if(c.status==="waiting" && !isMe){
      const div=document.createElement("div");
      div.className="challenge";
      div.innerHTML=`Mise : ${c.bet}<button>Accepter</button>`;
      div.querySelector("button").onclick=()=>join(id,c.bet);
      challengesEl.appendChild(div);
    }

    // JEU
    if(isMe && c.status==="playing"){
      currentChallenge=id;
      renderGame(c);
    }
  });
});

// ü§ù Rejoindre
async function join(id,bet){
  const userRef = ref(db,"users/"+user);
  const snap = await get(userRef);
  if(bet > snap.val().credits) return alert("Cr√©dits insuffisants");

  await update(userRef,{ credits: snap.val().credits - bet });
  await update(ref(db,"d√©fis1v1/"+id),{
    status:"playing",
    "players/player2":{ uid:user, symbol:"O" }
  });
}

// üéÆ Rendu + logique
function renderGame(c){
  boardEl.innerHTML="";
  c.board.forEach((v,i)=>{
    const cell=document.createElement("div");
    cell.className="cell";
    cell.textContent=v;
    cell.onclick=()=>play(i,c);
    boardEl.appendChild(cell);
  });
}

async function play(i,c){
  const role=Object.keys(c.players).find(k=>c.players[k].uid===user);
  if(c.currentTurn!==role || c.board[i] || c.status!=="playing") return;

  c.board[i]=c.players[role].symbol;
  const win = checkWin(c.board);

  if(win){
    await finishGame(c, role);
    return;
  }

  if(c.board.every(v=>v)){
    await finishGame(c,"draw");
    return;
  }

  await update(ref(db,"d√©fis1v1/"+currentChallenge),{
    board:c.board,
    currentTurn: role==="player1"?"player2":"player1"
  });
}

// üèÅ Fin de partie
async function finishGame(c,result){
  const bet = c.bet;
  const players = c.players;

  if(result==="draw"){
    for(const p of Object.values(players)){
      const uRef = ref(db,"users/"+p.uid);
      const us = await get(uRef);
      await update(uRef,{ credits: us.val().credits + bet });
    }
    msg.textContent="ü§ù Match nul ‚Äì mise rembours√©e";
  }else{
    const winner = players[result].uid;
    const uRef = ref(db,"users/"+winner);
    const us = await get(uRef);
    await update(uRef,{ credits: us.val().credits + bet*2 });
    msg.textContent="üèÜ Victoire !";
  }

  await remove(ref(db,"d√©fis1v1/"+currentChallenge));
}

// üß† D√©tection victoire
function checkWin(b){
  const l=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
  return l.some(a=>b[a[0]]&&b[a[0]]===b[a[1]]&&b[a[1]]===b[a[2]]);
}
</script>
</body>
</html>
